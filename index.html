<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>ğŸ¤‘ SleviÄky</title>
<meta name="theme-color" content="#f5f5f5">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/beercss/beercss@v3.13.1/dist/cdn/beer.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/material-icons@1.13.14/iconfont/material-icons.min.css">
<link rel="manifest" href="/manifest.json">
<script src="/jquery.min.js"></script>
<style>
body {
    min-width: 320px;
}

/* VARIABLES */
:root {
    --market-image-height: 48px;
    --on-surface-light: #2c2c2c;
    --product-image-height: 100px;
    --surface-container-high-light: #e0e0e0;
    --surface-container-highest-light: #d4d4d4;
    --surface-container-light: #ececec;
    --surface-container-low-light: #f5f5f5;
}

/* debugger */
#debugger {
    width: 100%;
    position: fixed;
    z-index: 100;
}

.debugger-on {
    padding: 5px;
}

/* PWA */
.install-btn {z-index: 100;}

/* HELPERS */
.nowrap {white-space: nowrap !important;overflow: hidden;text-overflow: ellipsis;}
.notap {cursor: pointer;-webkit-tap-highlight-color: transparent;-moz-tap-highlight-color: transparent;-ms-tap-highlight-color: transparent;}
.hover {cursor: pointer;}
.mono {font-family: monospace;}
.noselect {-webkit-user-select: none;-ms-user-select: none;user-select:none;}
.bigger {font-size: 2rem;font-weight: bold;}

/* NAVIGATION quirks */
.grayscaled {
    filter: grayscale(100%);
    opacity: 0.5;
}

/* PÅ™idÃ¡ hladkÃ½ pÅ™echod pro vÅ¡echny zmÄ›ny v navigaci */
nav.top i, nav.top button, nav.top a {
    transition: all 0.3s ease;
}

/* Pokud chceÅ¡ pÅ™i pÅ™epnutÃ­ pÅ™idat i jemnÃ© probliknutÃ­ celÃ©ho pozadÃ­ */
.mode-switch-active {
    animation: flash 0.4s ease-out;
}

@keyframes flash {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
}

.slevicky {
    display: none;
}

.topnavtxt {
    display: none;
}

.downer {
    position: relative;
    top: 5px;
}

/* BUTTONS */
.btn-top {
    font-size: 1rem;
    background-color: 0 !important;
    color: white !important;
    border: 1px solid #000 !important;
    border-radius: 0!important;
    padding: 5px;
}

.btn-bottom {
    font-size: 1rem;
    background-color: 0 !important;
    color: white !important;
    border: 1px solid #000 !important;
    border-radius: 0!important;
    padding: 5px;
}

/* remove hover color on top NAV buttons */
nav.top button::before, nav.top button::after {background: none !important;}

/* default NAV buttons letter-spacing */
nav.bottom button {letter-spacing: 0;}

/* DEALS */
#deals {
    display: grid !important;
    gap: 5px;
    grid-template-columns: repeat(2, 1fr); /* mobil: 2 sloupce */
    width: 100%;
}

@media(min-width: 500px) {
    #deals {
        grid-template-columns: repeat(4, 1fr); /* tablet: 4 sloupcÅ¯ */
    }
    .btn-bottom {
        font-size: 1.3rem;
    }
    nav.bottom button {
        letter-spacing: 0.3rem;
    }
}
@media(min-width: 700px) {
    #deals {
        grid-template-columns: repeat(6, 1fr); /* tablet: 6 sloupcÅ¯ */
    }
    .btn-bottom {
        font-size: 1.7rem;
    }
    .slevicky {
        display: inline-block;
        font-size: 1.3rem;
        font-weight: bold;
    }
    .topnavtxt {
        display: inline-block;
    }
    nav.bottom button {
        letter-spacing: 0.5rem;
    }
}
@media(min-width: 992px) {
    #deals {
        grid-template-columns: repeat(8, 1fr); /* desktop: 8 sloupcÅ¯ */
    }
    .btn-bottom {
        font-size: 1.9rem;
    }
    .slevicky {
        display: inline-block;
        font-size: 1.5rem;
        font-weight: bold;
    }
    .topnavtxt {
        display: inline-block;
    }
    nav.bottom button {
        letter-spacing: 0.7rem;
    }
}
@media(min-width: 1800px) {
    #deals {
        grid-template-columns: repeat(10, 1fr); /* desktop: 10 sloupcÅ¯ */
    }
    .btn-bottom {
        font-size: 2.1rem;
    }
    .topnavtxt {
        display: inline-block;
    }
    nav.bottom button {
        letter-spacing: 1rem;
    }
}

/* CARD flexible */
.product-card {
    display: flex !important;
    justify-content: space-between;
    flex-direction: column;
    height: 100%;
    margin: 0 !important;
    padding: 5px;
    overflow: hidden;
    background: white;
}

/* MARKET image */
.market-image {
    display: inline-block;
    width: auto;
    height: var(--market-image-height);
    object-fit: contain;
    margin: 0 auto;
    border-radius: 0 !important;
    padding-bottom: 10px;
}

/* PRODUCT image */
.product-image {
    display: block;
    width: 100%;
    height: var(--product-image-height); /* fixnÃ­ vÃ½Å¡ka pro srovnÃ¡nÃ­ Å™Ã¡dkÅ¯ */
    object-fit: contain; /* obrÃ¡zek se nebude deformovat */
    margin: 5px 0;
    border-radius: 3px !important;
}

.image-wrapper {
    height: var(--product-image-height);
    display: flex;
    align-items: center;
    justify-content: center;
}

.product-name {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-align: center;
    line-height: 1.4rem;
    height: 3rem; /* 2x 1.4rem + overhead */
    border-radius: 0 !important;
    padding-top: 10px;
}

.product-price {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: auto;
}

.old-price {
    font-size: 0.8rem;
    text-decoration: line-through;
    font-weight: bold;
    color: red;
}

.new-price {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--primary);
}

/* bottom NAV separators */
nav.bottom > button:not(:last-child) {
  border-right: none !important;
  background-image: linear-gradient(to bottom, 
    transparent 10%,
    #444 10%,
    #888 70%,
    #444 25%,
    #000 100%
  );
  background-position: center right;
  background-size: 2px 100%;
  background-repeat: no-repeat;
}
  
nav.bottom button {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
}
</style>
</head>
<body class="light">

<!-- TOP navigation - righthanded -->
<nav class="righthanded top notap nowrap black white-text">
    <button class="install-btn light-blue" style="display: none;">
        <span>Instalovat â™¥ï¸</span>
    </button>
    <div class="max noselect">
        <span class="billionaire">
            <span class="bigger">ğŸ¤‘</span>&nbsp;&nbsp;<span class="slevicky bold">SleviÄky</span>
        </span>
    </div>
    <button data-id="about" class="about-btn transparent white-text">
        <i>info</i>
        <span class="topnavtxt downer">Info</span>
    </button>
    <button data-id="settings" class="settings-btn transparent white-text">
        <i>settings</i>
        <span class="topnavtxt downer">NastavenÃ­</span>
    </button>
    <button data-id="refresh" class="refresh-btn transparent white-text">
        <i>refresh</i>
    </button>
</nav>

<!-- TOP navigation - lefthanded -->
<nav class="lefthanded top notap nowrap black white-text" style="display: none;">
    <button data-id="refresh" class="refresh-btn transparent white-text">
        <i>refresh</i>
    </button>
    <button data-id="settings" class="settings-btn transparent white-text">
        <i>settings</i>
        <span class="topnavtxt downer">NastavenÃ­</span>
    </button>
    <button data-id="about" class="about-btn transparent white-text">
        <i>info</i>
        <span class="topnavtxt downer">Info</span>
    </button>
    <div class="max noselect">
        <span class="billionaire">
            <span class="bigger">ğŸ¤‘</span>&nbsp;&nbsp;<span class="slevicky bold">SleviÄky</span>
        </span>
    </div>
    <button class="install-btn light-blue" style="display: none;">
        <span>Instalovat â™¥ï¸</span>
    </button>
</nav>

<!-- BOTTOM navigation - righthanded -->
<nav class="righthanded bottom notap black white-text grid no-space" style="display: grid; grid-template-columns: repeat(5, 1fr); height: auto;">
    <button id="but5" title="NÃPOJE - CUKROVINKY - OSTATNÃ" class="nowrap btn-bottom black white-text bold s1">ğŸ·ğŸ¬ğŸ“¦</button>
    <button id="but4" title="MASO - UZENINY - TUKY" class="nowrap btn-bottom black white-text bold s1">ğŸ¥©ğŸ¥“ğŸ§ˆ</button>
    <button id="but3" title="OBILOVINY - LUÅ TÄšNINY - KOÅ˜ENÃ" class="nowrap btn-bottom black white-text bold s1">ğŸŒ¾ğŸ«˜ğŸŒ¶ï¸</button>
    <button id="but2" title="MLÃ‰KO - SÃRY - VEJCE" class="nowrap btn-bottom black white-text bold s1">ğŸ¥›ğŸ§€ğŸ¥š</button>
    <button id="but1" title="ZELENINA - OVOCE - OÅ˜ECHY" class="nowrap btn-bottom black white-text bold s1">ğŸ¥¦ğŸğŸ¥œ</button>
</nav>

<!-- BOTTOM navigation - lefthanded -->
<nav class="lefthanded bottom notap black white-text grid no-space" style="display: none; grid-template-columns: repeat(5, 1fr); height: auto;">
    <button id="but1" title="ZELENINA - OVOCE - OÅ˜ECHY" class="nowrap btn-bottom black white-text bold s1">ğŸ¥¦ğŸğŸ¥œ</button>
    <button id="but2" title="MLÃ‰KO - SÃRY - VEJCE" class="nowrap btn-bottom black white-text bold s1">ğŸ¥›ğŸ§€ğŸ¥š</button>
    <button id="but3" title="OBILOVINY - LUÅ TÄšNINY - KOÅ˜ENÃ" class="nowrap btn-bottom black white-text bold s1">ğŸŒ¾ğŸ«˜ğŸŒ¶ï¸</button>
    <button id="but4" title="MASO - UZENINY - TUKY" class="nowrap btn-bottom black white-text bold s1">ğŸ¥©ğŸ¥“ğŸ§ˆ</button>
    <button id="but5" title="NÃPOJE - CUKROVINKY - OSTATNÃ" class="nowrap btn-bottom black white-text bold s1">ğŸ·ğŸ¬ğŸ“¦</button>
</nav>

<!-- DEALS grid -->
<main class="container">
    <noscript>
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: white; z-index: 9999; text-align: center; padding: 20px;">
            <h3>
                Tahle appka je zcela zÃ¡vislÃ¡ na pouÅ¾itÃ­ JavaScriptu ğŸ˜ï¸
                <br><br>
                Bez nÄ›j to prostÄ› nepÅ¯jde ...
            </h3>
        </div>
    </noscript>    <!-- debugger -->
    <div id="debugger" class="notap noselect black white-text debugger"></div>
    <div id="deals" class=""></div>
</main>

<script>
    const version = '{{GIT_REV}}';
    const git_build_date = '{{DATE_REV}}';
    const git_revisions = '{{COUNT_REV}}';

    document.addEventListener('DOMContentLoaded', () => {
        initApp();
    });

    const initApp = () => {
        // fetch('https://slevicky.pages.dev/koopi.json').then(response => response.json()).then(data => renderDeals(data)).catch(error => console.error('Chyba naÄÃ­tÃ¡nÃ­ dat:', error));

        // data mockup
        const mockDeals = [
            {name: 'KÃ¡va Intenso', store: 'hruska', oldPrice: '129,90', newPrice: '89,90', image: 'images/kava-instantni-gold-selection-crema-tchibo-1_170_340.webp' },
            {name: 'MlÃ©ko plnotuÄnÃ© 1L', store: 'billa', oldPrice: '25,90', newPrice: '19,90', image: 'images/mleko-cerstve-1_170_340.webp' },
            {name: 'KÃ¡va Intenso', store: 'kaufland', oldPrice: '129,90', newPrice: '89,90', image: 'images/kava-instantni-gold-selection-crema-tchibo-1_170_340.webp' },
            {name: 'MlÃ©ko plnotuÄnÃ© 1L', store: 'penny', oldPrice: '25,90', newPrice: '19,90', image: 'images/mleko-cerstve-1_170_340.webp' },
            {name: 'KÃ¡va Intenso', store: 'albert', oldPrice: '129,90', newPrice: '89,90', image: 'images/kava-instantni-gold-selection-crema-tchibo-1_170_340.webp' },
            {name: 'MlÃ©ko plnotuÄnÃ© 1L', store: 'flop', oldPrice: '25,90', newPrice: '19,90', image: 'images/mleko-cerstve-1_170_340.webp' },
            {name: 'MÃ¡slo ÄerstvÃ© 250g', store: 'lidl', oldPrice: '45,90', newPrice: '32,90', image: 'images/maslo_170_340.webp' },
            {name: 'Jogurt bÃ­lÃ½', store: 'kaufland', oldPrice: '15,90', newPrice: '9,90', image: 'images/jogurt-jihocesky-madeta-1_170_340.webp' },
            {name: 'PÃ¡rky v akci', store: 'globus', oldPrice: '99,90', newPrice: '69,90', image: 'images/parky-veprove-k-classic-1_170_340.webp' }
        ];
        const fullMock = [...mockDeals, ...mockDeals, ...mockDeals, ...mockDeals];
        renderDeals(fullMock);
    };

    /* Renderer */
    const renderDeals = (deals) => {
        const dealsGrid = document.getElementById('deals');
        if (!dealsGrid) return;

        /* Template */
        dealsGrid.innerHTML = deals.map(deal => `
            <article class="product-card" data-name="${deal.name}" data-market="${deal.store}">
                <img src="/markets/${deal.store}.webp" alt="${deal.store}" class="notap market-image">
                <div class="product-image-container">
                    <div class="image-wrapper">
                        <img src="/${deal.image}" alt="${deal.name}" title="${deal.name} - ${deal.image}" class="notap product-image">
                    </div>
                </div>
                <div class="product-name" title="${deal.name}">${deal.name}</div>
                <div class="product-price">
                    <span class="old-price">${deal.oldPrice}</span>
                    <span class="new-price">${deal.newPrice} KÄ</span>
                </div>
            </article>
        `).join('');
    };

    /* UI bindings */
    $(document).ready(function() {
        
        // billionaire button
        $('.billionaire').on('click', function() {
            window.scrollTo({top: 0, behavior: 'smooth'});
        });

        // about button
        $('.about-btn').on('click', function() {
            alert("\n\nğŸ¤‘ SleviÄky\n\nğŸ‘¾ build: {{GIT_REV}} revision: {{COUNT_REV}}\n\n");
        });
        
        // settings button
        $('.settings-btn').on('click', function() {
            switchHands();
        });

        // switch handedness
        function switchHands() {
            $('body').addClass('mode-switch-active');
            $('.lefthanded').toggle();
            $('.righthanded').toggle();
            const currentMode = $('.lefthanded').is(':visible') ? 'left' : 'right';
            localStorage.setItem('handedness', currentMode);
            setTimeout(() => {$('body').removeClass('mode-switch-active');}, 100);
        }

        // process handedness from localStorage
        const savedHandedness = localStorage.getItem('handedness');
        if (savedHandedness === 'left') {
            $('.lefthanded').show();
            $('.righthanded').hide();
        } else if (savedHandedness === 'right') {
            $('.lefthanded').hide();
            $('.righthanded').show();
        }

        // refresh button
        $('.refresh-btn').on('click', function() {
            $(this).prop('disabled', true).html('<i>schedule</i>');
            const buster = Math.random().toString(36).substring(2, 6);
            location.href = '/?' + buster;
        });

        // simple debugger
        function debug(x) {
            $('#debugger').html('debug: ' + x).addClass('debugger-on');
            setTimeout(function() {
                $('#debugger').html('').removeClass('debugger-on');
            }, 5000);
        }
        $('#debugger').on('click', function() {
            $('#debugger').html('').removeClass('debugger-on');
        });

        // context event hanlder
        window.handleContextEvent = function(e) {
            const card = e.target.closest('.product-card');
            if (card) {
                const productName = card.querySelector('.product-name')?.innerText;
                debug('produkt: ' + productName);
                $(card).fadeOut(100).fadeIn(100);
                return false;
            }

            // data-id
            const elementWithId = e.target.closest('[data-id]');
            if (elementWithId) {
                const id = elementWithId.getAttribute('data-id');
                debug('data-id: ' + id);
                return false;
            }

            // fallback
            const info = e.target.title || e.target.id || e.target.tagName;
            debug('Target: ' + info);
            return false;
        }

        // keyboard click
        window.onkeydown = function(e) {
            debug('Key: '+ e.key);
        }

    });

    /* Service Worker */
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }

    /* PWA install buttons */
    let deferredPrompt;

    // querySelectorAll vybere vÅ¡echny prvky s touto tÅ™Ã­dou
    const installButtons = document.querySelectorAll('.install-btn');

    // PWA installer
    installButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
            if (deferredPrompt) {
                installButtons.forEach(b => b.style.display = 'none');
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
            }
        });
    });
    
    // EVENT LISTENERS
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installButtons.forEach(btn => {
            btn.style.display = 'block';
        });
    });

    window.addEventListener('appinstalled', () => {
        installBtn.style.display = 'none';
        deferredPrompt = null;
    });

    window.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        window.handleContextEvent(e);
    }, true);

    window.addEventListener('dblclick', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        window.handleContextEvent(e);
    }, true);

</script>
</body>
</html>